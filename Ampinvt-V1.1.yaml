# cat ampinvt_mppt.yaml 
# ==========================================================
# Ampinvt MPPT V12 (Template Optimized)
# ==========================================================
device_info:
  manufacturer: "Ampinvt"
  model: "Solar MPPT Controller"

# ğŸŸ¢ [V11] è®€å–æŒ‡ä»¤ç­–ç•¥
read_commands:
  - id: "cmd_read_all"
    fc: 0xB1
    response_len: 93
    custom_payload: [0x01, 0x00, 0x00, 0x00, 0x00]

# ğŸŸ¢ [V12] å®šç¾©åº« (Templates)
definitions:
  # 1. é è¨­å€¼
  defaults:
    length: 1
    scale: 1.0
    unit: ""

  # 2. æ•¸å€¼æ˜ å°„è¡¨
  value_maps:
    map_ok_err:
      0: "æ­£å¸¸"
      1: "ç•°å¸¸"
    map_on_off:
      0: "é—œé–‰"
      1: "é–‹å•Ÿ"
    map_stop_enable:
      0: "åœæ­¢"
      1: "å•Ÿç”¨"
    map_charge_status:
      0: "åœå……"
      1: "å……é›»"

  # 3. HA å¤–è§€æ¨¡æ¿
  ha_profiles:
    # --- æ•¸å€¼é¡ ---
    pf_voltage_10:  {type: "sensor", device_class: "voltage", state_class: "measurement", unit_of_meas: "V", scale: 10.0}
    pf_voltage_100: {type: "sensor", device_class: "voltage", state_class: "measurement", unit_of_meas: "V", scale: 100.0}
    pf_current:     {type: "sensor", device_class: "current", state_class: "measurement", unit_of_meas: "A", scale: 100.0}
    pf_temp:        {type: "sensor", device_class: "temperature", state_class: "measurement", unit_of_meas: "Â°C", signed: true}
    pf_energy:      {type: "sensor", device_class: "energy", state_class: "total_increasing", unit_of_meas: "Wh"}

    # --- ç‹€æ…‹é¡ ---
#    pf_alert:       {type: "binary_sensor", device_class: "problem"} # ç•°å¸¸=ç´…
#    pf_running:     {type: "binary_sensor", device_class: "running"} # é‹è¡Œ=ç¶ 
#    pf_switch:      {type: "binary_sensor", device_class: "power"}   # é–‹é—œ=é€šé›»
    pf_alert:       {type: "sensor", device_class: "problem"} # ç•°å¸¸=ç´…
    pf_running:     {type: "sensor", device_class: "running"} # é‹è¡Œ=ç¶ 
    pf_switch:      {type: "sensor", device_class: "power"}   # é–‹é—œ=é€šé›»
    pf_charging:    {type: "sensor", icon: "mdi:battery-charging"}
    pf_text_status: {type: "sensor", icon: "mdi:information-outline"} # æ–‡å­—æè¿°å°ˆç”¨
    # --- è¨­å®šé¡ ---
    pf_set_vol:     {type: "number", mode: "box", min: 9.0, max: 70.0, step: 0.1, unit_of_meas: "V"}
    pf_set_curr:    {type: "number", mode: "slider", min: 0.0, max: 60.0, step: 1.0, unit_of_meas: "A"}

# ==========================================================
# 1. å‚³æ„Ÿå™¨ (Sensors)
# ==========================================================
sensors:
  # --- Status Bits ---
  - key: "run_status"
    name: "offset3 é‹è¡Œç‹€æ…‹ç¢¼"
    command_id: "cmd_read_all"
    offset: 3
    bits:
      - bit: 0
        name: "offset3 é‹ä½œç‹€æ…‹"
        # é€™è£¡æœ‰ç‰¹æ®Šæ–‡å­—ï¼Œä½¿ç”¨ map å±€éƒ¨è¦†è“‹
        map: {0: "æ­£å¸¸", 1: "ç•°å¸¸(é›»æ± è­˜åˆ¥éŒ¯èª¤)"}
        ha_profile: "pf_text_status"
      - bit: 1
        name: "offset3 é›»æ± ç‹€æ…‹"
        map: {0: "æ­£å¸¸", 1: "ç•°å¸¸"}
        ha_profile: "pf_text_status"
      - bit: 2
        name: "offset3 é¢¨æ‰‡ç‹€æ…‹"
        map: {0: "æ­£å¸¸", 1: "ç•°å¸¸"}
        ha_profile: "pf_text_status"
      - bit: 3
        name: "offset3 æº«åº¦ç‹€æ…‹"
        map: {0: "æ­£å¸¸", 1: "ç•°å¸¸"}
        ha_profile: "pf_text_status"
      - bit: 4
        name: "offset3 ç›´æµè¼¸å‡º"
        map: {0: "æ­£å¸¸", 1: "ç•°å¸¸"}
        ha_profile: "pf_text_status"
      - bit: 5
        name: "offset3 å…§éƒ¨æº«åº¦1"
        map: {0: "æ­£å¸¸", 1: "ç•°å¸¸(éå£“)"}
        ha_profile: "pf_text_status"
      - bit: 6
        name: "offset3 å…§éƒ¨æº«åº¦2"
        map: {0: "æ­£å¸¸", 1: "ç•°å¸¸(éå£“)"}
        ha_profile: "pf_text_status"
      - bit: 7
        name: "offset3 å¤–éƒ¨æº«åº¦"
        map: {0: "æ­£å¸¸", 1: "ç•°å¸¸(éå£“)"}
        ha_profile: "pf_text_status"

  - key: "charge_status"
    name: "offset4 å……é›»ç‹€æ…‹ç¢¼"
    command_id: "cmd_read_all"
    offset: 4
    bits:
      - bit: 0
        name: "offset4 å……é›»ç‹€æ…‹"
        map_profile: "map_charge_status"
        ha_profile: "pf_charging"
      - bit: 1
        name: "offset4 å‡å……"
        map_profile: "map_stop_enable"
        ha_profile: "pf_charging"
      - bit: 2
        name: "offset4 MPPTæ¨¡å¼"
        map_profile: "map_stop_enable"
        ha_profile: "pf_charging"
      - bit: 3
        name: "offset4 æµ®å……"
        map_profile: "map_stop_enable"
        ha_profile: "pf_charging"
      - bit: 4
        name: "offset4 å……é›»é™æµ"
        map_profile: "map_stop_enable"
        ha_profile: "pf_charging"
      - bit: 5
        name: "offset4 å……é›»é™é¡"
        map_profile: "map_stop_enable"
        ha_profile: "pf_charging"
      - bit: 6
        name: "offset4 é ç«¯æ§åˆ¶ç¦å……"
        map_profile: "map_stop_enable"
        ha_profile: "pf_charging"
      - bit: 7
        name: "offset4 PVéå£“"
        map_profile: "map_stop_enable"
        ha_profile: "pf_charging"

  - key: "control_status"
    name: "offset5 æ§åˆ¶ç‹€æ…‹"
    command_id: "cmd_read_all"
    offset: 5
    bits:
      - bit: 0
        name: "offset5 å……é›»è¼¸å‡ºRelay"
        map_profile: "map_on_off"
        ha_profile: "pf_alert"
      - bit: 1
        name: "offset5 è² è¼‰è¼¸å‡º"
        map_profile: "map_on_off"
        ha_profile: "pf_alert"
      - bit: 2
        name: "offset5 é¢¨æ‰‡é–‹å•Ÿ"
        map_profile: "map_on_off"
        ha_profile: "pf_alert"
      - bit: 4
        name: "offset5 éå……ä¿è­·"
        map: {0: "æ­£å¸¸", 1: "ç•°å¸¸(éå……ä¿è­·å•Ÿç”¨)"}
        ha_profile: "pf_alert"
      - bit: 5
        name: "offset5 éå£“ä¿è­·"
        map: {0: "æ­£å¸¸", 1: "ç•°å¸¸(éå£“ä¿è­·å•Ÿç”¨)"}
        ha: {type: "sensor", icon: "mdi:alert-circle"}

  # --- æ•¸å€¼æ„Ÿæ¸¬å™¨ (å¤§é‡ä½¿ç”¨æ¨¡æ¿) ---
  - key: "pv_voltage"
    name: "PV è¼¸å…¥é›»å£“"
    command_id: "cmd_read_all"
    offset: 30
    length: 2
    ha_profile: "pf_voltage_10" # Scale 10

  - key: "battery_voltage"
    name: "é›»æ± å¯¦æ™‚é›»å£“"
    command_id: "cmd_read_all"
    offset: 32
    length: 2
    ha_profile: "pf_voltage_100" # Scale 100

  - key: "charge_current"
    name: "ç•¶å‰å……é›»é›»æµ"
    command_id: "cmd_read_all"
    offset: 34
    length: 2
    ha_profile: "pf_current"

  - key: "internal_temp"
    name: "è¨­å‚™å…§éƒ¨æº«åº¦"
    command_id: "cmd_read_all"
    offset: 36
    length: 2
    scale: 10.0  # ä¾ç…§æ‚¨èˆŠç‰ˆè¨­å®š
    ha_profile: "pf_temp"

  - key: "battery_temp"
    name: "é›»æ± å¤–éƒ¨æº«åº¦"
    command_id: "cmd_read_all"
    offset: 40
    length: 2
    scale: 100.0   # ä¾ç…§æ‚¨èˆŠç‰ˆè¨­å®š
    ha_profile: "pf_temp"

  - key: "today_yield_wh"
    name: "ä»Šæ—¥ç™¼é›»é‡"
    command_id: "cmd_read_all"
    offset: 44
    length: 4
    ha_profile: "pf_energy"

  - key: "total_yield_wh"
    name: "ç´¯è¨ˆç¸½ç™¼é›»é‡"
    command_id: "cmd_read_all"
    offset: 48
    length: 4
    ha_profile: "pf_energy"

  # --- åƒæ•¸å›è®€ ---
  - key: "rated_voltage"
    name: "ç³»çµ±é¡å®šé›»å£“"
    command_id: "cmd_read_all"
    offset: 16
    length: 2
    ha_profile: "pf_voltage_100"

  - key: "equalize_voltage"
    name: "å‡å……é›»å£“(ç•¶å‰)"
    command_id: "cmd_read_all"
    offset: 18
    length: 2
    ha_profile: "pf_voltage_100"

  - key: "float_voltage"
    name: "æµ®å……é›»å£“(ç•¶å‰)"
    command_id: "cmd_read_all"
    offset: 20
    length: 2
    ha_profile: "pf_voltage_100"

  - key: "discharge_limit"
    name: "æ”¾é›»ä¸‹é™(ç•¶å‰)"
    command_id: "cmd_read_all"
    offset: 22
    length: 2
    ha_profile: "pf_voltage_100"

  - key: "discharge_recover"
    name: "éæ”¾å›å¾©"
    command_id: "cmd_read_all"
    offset: 54
    length: 2
    ha_profile: "pf_voltage_100"

  - key: "over_voltage_protection"
    name: "éå£“ä¿è­·"
    command_id: "cmd_read_all"
    offset: 56
    length: 2
    ha_profile: "pf_voltage_100"

  - key: "over_voltage_recovery"
    name: "éå£“æ¢å¾©"
    command_id: "cmd_read_all"
    offset: 58
    length: 2
    ha_profile: "pf_voltage_100"

  - key: "max_charge_current"
    name: "å……é›»æœ€å¤§é›»æµ(ç•¶å‰)"
    command_id: "cmd_read_all"
    offset: 26
    length: 2
    ha_profile: "pf_current"

  - key: "run_charge_current_limit"
    name: "å……é›»æœ€å¤§é›»æµ(è¨­å®š)"
    command_id: "cmd_read_all"
    offset: 28
    length: 2
    ha_profile: "pf_current"

  - key: "battery_type"
    name: "é›»æ± é¡å‹"
    command_id: "cmd_read_all"
    offset: 8
    map: {0: "0 é‰›é…¸(å…ç¶­è­·)", 1: "1 é‰›é…¸(è† é«”)", 2: "2 é‰›é…¸(æ¶²é«”)", 3: "3 é‹°é›»æ± "}
    ha: {type: "sensor", icon: "mdi:car-battery"}

  - key: "recognition_mode"
    name: "è­˜åˆ¥æ–¹å¼"
    command_id: "cmd_read_all"
    offset: 9
    map: {0: "è‡ªå‹•è­˜åˆ¥", 1: "æ‰‹å‹•12V", 2: "æ‰‹å‹•24V", 3: "æ‰‹å‹•36V", 4: "æ‰‹å‹•48V", 5: "æ‰‹å‹•60V", 6: "æ‰‹å‹•72V", 7: "æ‰‹å‹•84V", 8: "æ‰‹å‹•96V"}
    ha: {type: "sensor", icon: "mdi:eye-refresh"}

  - key: "battery_count"
    name: "é›»æ± ä¸²æ•¸"
    command_id: "cmd_read_all"
    offset: 10
    unit: "ä¸²"
    ha: {type: "sensor", icon: "mdi:battery-plus"}

  - key: "load_control_mode"
    name: "è² è¼‰æ¨¡å¼"
    command_id: "cmd_read_all"
    offset: 11
    map: {0: "é—œé–‰", 1: "è‡ªå‹•", 2: "æ™‚é–“", 3: "å…‰æ§", 4: "é ç¨‹"}
    ha: {type: "sensor", icon: "mdi:cog-transfer"}


# ==========================================================
# 2. è¨­å®šåƒæ•¸ (Settings)
# ==========================================================
settings:
  "0x09":
    key: "set_battery_type"
    name: "è¨­å®š-é›»æ± é¡å‹"
    write_fc: 0xD0
    data_len: 1
    link_sensor: "battery_type" # ğŸŸ¢ æ”¹å: link_sensor
    ha:
      type: "select"
      options: ["é‰›é…¸(å…ç¶­è­·)", "é‰›é…¸(è† é«”)", "é‰›é…¸(æ¶²é«”)", "é‹°é›»æ± "]
      icon: "mdi:car-battery"

  "0x0A":
    key: "set_battery_count"
    name: "è¨­å®š-é›»æ± ä¸²æ•¸"
    write_fc: 0xD0
    data_len: 1
    link_sensor: "battery_count"
    ha:
      type: "number"
      min: 1
      max: 16
      mode: "box"
      icon: "mdi:battery-plus"

  "0x0B":
    key: "set_recognition_mode"
    name: "è¨­å®š-è­˜åˆ¥æ–¹å¼"
    write_fc: 0xD0
    data_len: 1
    link_sensor: "recognition_mode"
    ha:
      type: "select"
      options: ["è‡ªå‹•è­˜åˆ¥", "æ‰‹å‹•12V", "æ‰‹å‹•24V", "æ‰‹å‹•36V", "æ‰‹å‹•48V", "æ‰‹å‹•60V", "æ‰‹å‹•72V", "æ‰‹å‹•84V", "æ‰‹å‹•96V"]
      icon: "mdi:eye-settings"

  "0x0C":
    key: "set_load_mode"
    name: "è¨­å®š-è² è¼‰æ¨¡å¼"
    write_fc: 0xD0
    data_len: 1
    link_sensor: "load_control_mode"
    ha:
      type: "select"
      options: ["é—œé–‰", "è‡ªå‹•(å…‰æ§+æ™‚æ§)", "æ™‚é–“æ§åˆ¶", "å…‰æ§æ¨¡å¼", "é ç¨‹æ§åˆ¶"]
      icon: "mdi:cog-transfer"

  # --- é›»å£“åƒæ•¸ (ä½¿ç”¨æ¨¡æ¿) ---
  "0x21":
    key: "set_equalize_voltage"
    name: "è¨­å®š3-å‡å……é›»å£“"
    write_fc: 0xD0
    data_len: 2
    scale: 100.0
    link_sensor: "equalize_voltage"
    ha_profile: "pf_set_vol"

  "0x22":
    key: "set_float_voltage"
    name: "è¨­å®š4-æµ®å……é›»å£“"
    write_fc: 0xD0
    data_len: 2
    scale: 100.0
    link_sensor: "float_voltage"
    ha_profile: "pf_set_vol"

  "0x23":
    key: "set_discharge_limit"
    name: "è¨­å®š6-éæ”¾ä¿è­·"
    write_fc: 0xD0
    data_len: 2
    scale: 100.0
    link_sensor: "discharge_limit"
    ha_profile: "pf_set_vol"

  "0x26":
    key: "set_discharge_recover"
    name: "è¨­å®š5-éæ”¾æ¢å¾©"
    write_fc: 0xD0
    data_len: 2
    scale: 100.0
    link_sensor: "discharge_recover"
    ha_profile: "pf_set_vol"

  "0x27":
    key: "set_over_prot_vol"
    name: "è¨­å®š1-éå£“ä¿è­·"
    write_fc: 0xD0
    data_len: 2
    scale: 100.0
    link_sensor: "over_voltage_protection"
    ha_profile: "pf_set_vol" # è¦†è“‹æ¨¡æ¿: base_min å¯åœ¨æ­¤è™•è¦†å¯«ï¼Œå¦‚æœä¸å¯«å°±ç”¨æ¨¡æ¿çš„ 9.0

  "0x28":
    key: "set_over_voltage_recovery"
    name: "è¨­å®š2-éå£“æ¢å¾©"
    write_fc: 0xD0
    data_len: 2
    scale: 100.0
    link_sensor: "over_voltage_recovery"
    ha_profile: "pf_set_vol" # è¦†è“‹æ¨¡æ¿: base_min å¯åœ¨æ­¤è™•è¦†å¯«ï¼Œå¦‚æœä¸å¯«å°±ç”¨æ¨¡æ¿çš„ 9.0

  # --- é›»æµåƒæ•¸ ---
  "0x25":
    key: "set_max_charge_curr"
    name: "è¨­å®š-å……é›»æœ€å¤§é›»æµ"
    write_fc: 0xD0
    data_len: 2
    scale: 100.0
    link_sensor: "max_charge_current"
    ha_profile: "pf_set_curr"
