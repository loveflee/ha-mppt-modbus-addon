# ğŸŒ Ampinvt MPPT æ™ºæ…§ç›£æ§ç³»çµ± (V7.7)

é€™æ˜¯ç‚ºä½›å±±é‡‘å»£æº (Ampinvt) MPPT å¤ªé™½èƒ½å……é›»æ§åˆ¶å™¨è¨­è¨ˆçš„é«˜ç´šç›£æ§èˆ‡æ§åˆ¶ Add-onã€‚æœ¬å°ˆæ¡ˆå°ˆæ³¨æ–¼ **ç©©å®šæ€§ã€ç¡¬é«”å®‰å…¨æ€§** èˆ‡ **æƒ¡åŠ£é€šè¨Šç’°å¢ƒä¸‹çš„é«˜éŸŒæ€§ (Resilience)**ã€‚

---

## âœ¨ æ ¸å¿ƒåŠŸèƒ½èˆ‡ç‰¹è‰² (Key Features)

* **ğŸ›¡ï¸ é›¶ä¿¡ä»»å®‰å…¨å•Ÿå‹• (Zero Trust Startup)**
    * **EN**: The system requires a successful, verified read of the device's actual hardware specs (Type, Voltage, Max Amp) before registering any HA entities. If the device is offline during startup, **no unsafe entity will be created**.
    * **TW**: ç³»çµ±å•Ÿå‹•æ™‚å¿…é ˆæˆåŠŸè®€å–ä¸¦é©—è­‰è¨­å‚™çš„çœŸå¯¦ç¡¬é«”è¦æ ¼ (é›»æ± é¡å‹ã€ä¸²æ•¸ã€æœ€å¤§é›»æµ) å¾Œï¼Œæ‰è¨»å†Šå¯¦é«”ã€‚å¦‚æœè¨­å‚™é›¢ç·šï¼Œ**ä¸æœƒå‰µå»ºä»»ä½•å±éšªçš„å¯¦é«”**ã€‚

* **ğŸŸ¢ å°ˆå±¬é€£ç·šç‹€æ…‹æ„ŸçŸ¥ (Dedicated Connectivity Sensor)**
    * **EN**: Adds a distinct `binary_sensor.connectivity` for each MPPT. This explicitly turns OFF (red light) after 20 failures, allowing users to clearly distinguish between 'system crash' and 'device offline'.
    * **TW**: ç‚ºæ¯å€‹ MPPT è¨­å‚™æ–°å¢å°ˆå±¬çš„ã€Œé€£ç·šç‹€æ…‹ç‡ˆã€ã€‚ä¸€æ—¦é€£çºŒå¤±æ•— 20 æ¬¡ï¼Œç‡ˆè™Ÿæœƒæ˜ç¢ºé¡¯ç¤ºã€Œä¸­æ–·ã€ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…é€šéè‡ªå‹•åŒ–åˆ¤æ–·è¨­å‚™ç¡¬é«”æ˜¯å¦æ•…éšœã€‚

* **ğŸ§  ç¡¬é«”è¦æ ¼é–å®š (Hardware Specification Lock)**
    * **EN**: Automatically reads the true physical current limit (e.g., 60A) and enforces it as the maximum value on the HA setting slider. **LiFePO4 Safety**: Locks the maximum charging voltage to 14.6V/12V equivalent.
    * **TW**: è‡ªå‹•è®€å–ç¡¬é«”æœ€å¤§å……é›»é›»æµï¼Œä¸¦é–å®š HA è¨­å®šæ»‘æ¡¿çš„ä¸Šé™ã€‚**é‹°éµå®‰å…¨**ï¼šé–å®šé‹°é›»æ± çš„æœ€é«˜å……é›»é›»å£“åœ¨ 14.6V/12V (éµé‹°å®‰å…¨æ¥µé™)ã€‚

---

## âš ï¸ ç³»çµ±ä¸­è‚¯è©•ä¼°ï¼šå„ªé»èˆ‡ç¼ºé™· (Candid Assessment: V7.7)

### âœ… å„ªé»ï¼šæ¥µé™ç©©å®šèˆ‡æ™ºæ…§åŒ– (The Good - High Resilience)

| **é ˜åŸŸ** | **V7.7 çš„å„ªå‹¢** | **èªªæ˜** |
| :--- | :--- | :--- |
| **ç©©å®šæ€§ (Stability)** | **æ¥µé«˜** (High Resilience) | æ¡ç”¨ Socket åŒæ­¥åº•å±¤ï¼Œåœ¨å»‰åƒ¹ Modbus Gateway æˆ–é«˜å¹²æ“¾ç’°å¢ƒä¸‹ï¼Œæ¯” Asyncio æ›´èƒ½æŠ—è¡¡æ™‚åºéŒ¯èª¤ã€‚ |
| **æ§åˆ¶é«”é©— (UX)** | **ä½å»¶é²æ’éšŠ** (Low Latency) | æ’éšŠè¼ªè©¢æ©Ÿåˆ¶ç¢ºä¿æ§åˆ¶æŒ‡ä»¤äº«æœ‰å„ªå…ˆæ¬Šï¼Œæ“ä½œéŸ¿æ‡‰é€Ÿåº¦æ¥µå¿« (< 0.5ç§’)ã€‚ |
| **æ•…éšœè™•ç†** | **è³‡æºç¯€çœ** (Resource Saving) | **å¤šéšæ®µæ‡²ç½°æ©Ÿåˆ¶** é¿å…äº† CPU è³‡æºæµªè²»åœ¨ç„¡æ•ˆçš„é€£ç·šé‡è©¦ä¸Šã€‚ |

### âŒ ç¼ºé»èˆ‡å…ˆå¤©ç¼ºé™· (The Flaws - Structural Limitations)

| **é ˜åŸŸ** | **V7.7 çš„æ¥µé™èˆ‡ç¼ºé™·** | **èªªæ˜** |
| :--- | :--- | :--- |
| **æ“´å……æ€§ (Scale)** | **å–®ç·šç¨‹çš„ç‰©ç†ä¸Šé™** | åƒ…èƒ½ç©©å®šæœå‹™ **10 å°è¨­å‚™ä»¥å…§**ã€‚è¨­å‚™æ•¸é‡å¢åŠ å°‡ç·šæ€§å»¶é•·è¼ªè©¢é€±æœŸã€‚ |
| **è³‡æ–™å®Œæ•´æ€§** | **æ–·ç¶²å³ä¸Ÿå¤±** (Data Loss) | **å…ˆå¤©ç¼ºé™·**ï¼šç¼ºä¹æœ¬åœ°è³‡æ–™åº«ç·©å­˜ (SQLite)ã€‚ç¶²è·¯ä¸­æ–·æœŸé–“ï¼Œç™¼é›»æ•¸æ“šå°‡æ°¸ä¹…éºå¤±ã€‚ |
| **å•Ÿå‹•é«”é©—** | **æ²ˆé»˜çš„å„€å¼æ„Ÿ** (Startup Silence) | ç‚ºäº†å®‰å…¨ï¼Œè‹¥è¨­å‚™é›¢ç·šï¼ŒHA ä»‹é¢å°‡ **å®Œå…¨ç©ºç™½**ï¼Œä½¿ç”¨è€…éœ€è¦è€å¿ƒç­‰å¾…å…¶èƒŒæ™¯é‡è©¦æˆåŠŸã€‚ |
| **æ¶æ§‹è² æ“”** | **ç¡¬é—–å¼é€šè¨Š** (Brute-Force Comms) | `flush_buffer` é›–ç„¶æœ‰æ•ˆï¼Œä½†æœ¬è³ªä¸Šæ˜¯é€šé **é¡å¤–çš„ CPU é€±æœŸ** ä¾†æ¸…é™¤é›œè¨Šï¼Œå½Œè£œåº•å±¤ç¡¬é«”çš„ä¸è¶³ã€‚ |

---
# âš™ï¸ Ampinvt MPPT ç›£æ§ç³»çµ±è¨­å®šæŒ‡å— (V7.7)

æœ¬æ–‡ä»¶è©³ç´°èªªæ˜ `config.yaml` æª”æ¡ˆä¸­æ‰€æœ‰å¯é…ç½®çš„é¸é …ã€‚è«‹æ ¹æ“šæ‚¨çš„ Home Assistant ç’°å¢ƒå’Œç¡¬é«”è¨­å®šé€²è¡Œä¿®æ”¹ã€‚

## 1. ç³»çµ±è¨­å®š (system)

| é¸é … | é¡å‹ | é è¨­å€¼ | åƒæ•¸ä½œç”¨èˆ‡å¡«å¯«èªªæ˜ |
| :--- | :--- | :--- | :--- |
| `debug` | `bool` | `false` | æ˜¯å¦é–‹å•ŸåµéŒ¯æ¨¡å¼ã€‚é–‹å•Ÿå¾Œï¼Œæ—¥èªŒä¸­æœƒé¡¯ç¤ºè©³ç´°çš„ Modbus åŸå§‹æ•¸æ“š (Hex)ï¼Œ**åƒ…å»ºè­°é™¤éŒ¯æ™‚é–‹å•Ÿ**ã€‚ |
| `timezone_offset` | `int` | `8` | **æ™‚å€è£œå„Ÿ**ã€‚è¨­å®šæ‚¨æ‰€åœ¨åœ°å€èˆ‡ UTC+0 çš„æ™‚å·® (å–®ä½ï¼šå°æ™‚)ã€‚ä¾‹å¦‚ï¼Œå°åŒ—/åŒ—äº¬æ™‚é–“ç‚º `8`ã€‚ç”¨æ–¼å…§å»ºçš„æ™‚é–“åŒæ­¥åŠŸèƒ½ã€‚ |
| `language` | `str` | `"tw"` | ä»‹é¢èªç³»é¸æ“‡ã€‚ç›®å‰æ”¯æ´ `"tw"` (ç¹é«”ä¸­æ–‡) æˆ– `"en"` (è‹±æ–‡)ã€‚ |

## 2. æ•…éšœæ‡²ç½°æ©Ÿåˆ¶ (blacklist) ğŸ›¡ï¸

**ã€æ¥µç«¯éŸŒæ€§åŠŸèƒ½ã€‘** ç”¨æ–¼è™•ç†å–®ä¸€è¨­å‚™çš„é€£çºŒé€šè¨Šå¤±æ•—ã€‚ç•¶è¨­å‚™æ•…éšœæ™‚ï¼Œç³»çµ±æœƒå°‡å…¶çŸ­æš«æˆ–é•·æœŸéš”é›¢ï¼Œä»¥ç¯€çœè³‡æºã€‚

| é¸é … | é¡å‹ | é è¨­å€¼ | åƒæ•¸ä½œç”¨èˆ‡å¡«å¯«èªªæ˜ |
| :--- | :--- | :--- | :--- |
| `fail_threshold` | `int` | `20` | **HA é›¢ç·šé–€æª»**ã€‚å–®ä¸€è¨­å‚™é€£çºŒå¤±æ•—é”åˆ°æ­¤æ¬¡æ•¸å¾Œï¼ŒHA ä¸Šçš„å¯¦é«”å°‡è¢«æ¨™è¨˜ç‚º `Unavailable` (è®Šç°)ã€‚ |
| `isolation_time` | `int` | `60` | **åˆå§‹éš”é›¢æ™‚é–“** (ç§’)ã€‚ç•¶è¨­å‚™é€£ç·šå¤±æ•—æ™‚ï¼Œç¬¬ä¸€æ¬¡éš”é›¢çš„æ™‚é–“é•·åº¦ã€‚**å»ºè­°è¨­ç‚º 60 ç§’**ã€‚ |
| `long_delay_threshold` | `int` | `10` | **é•·å»¶é²é–€æª»**ã€‚å–®ä¸€è¨­å‚™é€£çºŒå¤±æ•—æ¬¡æ•¸è¶…éæ­¤é–€æª»å¾Œï¼Œç³»çµ±å°‡é€²å…¥ã€Œé•·æœŸéš”é›¢ã€ã€‚ |
| `long_delay` | `int` | `3600` | **åš´é‡æ‡²ç½°æ™‚é–“** (ç§’)ã€‚ç•¶å¤±æ•—é”åˆ° `long_delay_threshold` å¾Œï¼Œæ¯æ¬¡é‡è©¦çš„é–“éš”æ™‚é–“ã€‚**é è¨­ 3600 ç§’å³ 1 å°æ™‚ (é¿å…è³‡æºæµªè²»)**ã€‚ |

## 3. Modbus é€šè¨Šè¨­å®š (modbus)

| é¸é … | é¡å‹ | é è¨­å€¼ | åƒæ•¸ä½œç”¨èˆ‡å¡«å¯«èªªæ˜ |
| :--- | :--- | :--- | :--- |
| `host` | `str` | `"192.168.106.12"` | **å¿…å¡«**ï¼šæ‚¨çš„ Modbus-TCP ç¶²é—œçš„ IP ä½å€ã€‚ |
| `port` | `int` | `502` | Modbus-TCP æœå‹™çš„ç«¯å£è™Ÿã€‚é™¤éæ‚¨çš„ç¶²é—œæœ‰ç‰¹æ®Šè¨­å®šï¼Œå¦å‰‡é€šå¸¸ç‚º `502`ã€‚ |
| `unit_ids` | `str` | `"1"` | **å¿…å¡«**ï¼šè¦ç›£æ§çš„ MPPT è¨­å‚™ ID (Slave ID)ã€‚å¤šå€‹è¨­å‚™è«‹ç”¨é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ `"1, 2, 3, 4"`ã€‚ |
| `timeout` | `float` | `3.0` | **Modbus è¶…æ™‚æ™‚é–“** (ç§’)ã€‚ç¨‹å¼ç­‰å¾…è¨­å‚™å›æ‡‰çš„æœ€é•·æ™‚é–“ã€‚**å»ºè­° 3.0 ç§’æˆ–æ›´ä½**ã€‚ |

## 4. MQTT Broker è¨­å®š (mqtt)

| é¸é … | é¡å‹ | é è¨­å€¼ | åƒæ•¸ä½œç”¨èˆ‡å¡«å¯«èªªæ˜ |
| :--- | :--- | :--- | :--- |
| `broker` | `str` | `"core-mosquitto"` | MQTT Broker çš„æœå‹™ IP æˆ–åç¨±ã€‚è‹¥èˆ‡ HA é‹è¡Œåœ¨åŒä¸€ä¸»æ©Ÿï¼Œå¯ä½¿ç”¨é è¨­å€¼ã€‚ |
| `port` | `int` | `1883` | MQTT ç«¯å£è™Ÿ (é SSL)ã€‚ |
| `username` | `str` | `"mqtt_user"` | MQTT ç™»å…¥å¸³è™Ÿã€‚ |
| `password` | `str` | `"mqtt_password"` | MQTT ç™»å…¥å¯†ç¢¼ã€‚ |
| `discovery_prefix` | `str` | `"homeassistant"` | HA MQTT Discovery çš„é è¨­å‰ç¶´ã€‚ |
| `node_id` | `str` | `"wifi01"` | è­˜åˆ¥æ­¤ Add-on å¯¦ä¾‹çš„ Node IDã€‚å½±éŸ¿å¯¦é«”çš„å”¯ä¸€ IDã€‚ |
| `device_name` | `str` | `"ampinvt_mppt"` | HA ä¸­é¡¯ç¤ºçš„è¨­å‚™åç¨±ã€‚ |
| `reset_discovery_on_exit` | `bool` | `false` | ç¨‹å¼çµæŸæ™‚æ˜¯å¦æ¸…é™¤ HA ä¸Šçš„æ‰€æœ‰å¯¦é«”è¨»å†Š (**ç”Ÿç”¢ç’°å¢ƒè«‹ä¿æŒ `false`**)ã€‚ |

## 5. è¼ªè©¢é–“éš”è¨­å®š (polling)

| é¸é … | é¡å‹ | é è¨­å€¼ | åƒæ•¸ä½œç”¨èˆ‡å¡«å¯«èªªæ˜ |
| :--- | :--- | :--- | :--- |
| `poll_interval` | `int` | `3` | **ä¸»å¾ªç’°é–“éš”** (ç§’)ã€‚ç¨‹å¼åœ¨è®€å®Œæ‰€æœ‰è¨­å‚™å¾Œï¼Œä¼‘æ¯çš„æ™‚é–“ã€‚æ­¤å€¼è¶Šä½ï¼Œæ•¸æ“šæ›´æ–°è¶Šå¿«ã€‚ |
| `delay_between_units` | `float` | `0.5` | **è¨­å‚™é–“å»¶é²** (ç§’)ã€‚è®€å–å®Œä¸€å°è¨­å‚™å¾Œï¼Œç­‰å¾…å¤šé•·æ™‚é–“å†è®€ä¸‹ä¸€å° (é¿å…ç¸½ç·šè¡çª)ã€‚ |
